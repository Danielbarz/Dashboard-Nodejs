name: strict-gate

on:
  pull_request:
    branches: [ "main", "master" ]
    types: [opened, synchronize, reopened]

jobs:
  defense-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x] # Tests against multiple Node versions

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install Dependencies (Clean)
      run: npm ci

    - name: Security Audit (Block vulnerabilities)
      # Fails if your coworkers added a package with known security issues
      run: npm audit --audit-level=high

    - name: Lint Code (Strict Mode)
      # Assumes you have a 'lint' script in package.json (e.g., eslint)
      run: npm run lint

    - name: Run Tests with Coverage
      # Assumes you have a 'test' script (e.g., jest --coverage)
      # This pipe command fails the job if coverage is below 80% (adjust threshold as needed)
      run: npm test -- --coverage --collectCoverageFrom='["src/**/*.{js,jsx,ts,tsx}"]' --coverageThreshold='{"global":{"lines":80}}'